name: OPS_SCA_SCAN
run-name: SCA Scan using GitHub Actions
 
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Name of the branch'
        required: true
        default: 'test'
 
      diff:
        description: 'Make the artifact from commit to commit (ex: true or false )'
        default: 'false'
 
      overall:
        description: 'Make the artifact based on the branch (ex: true or false )'
        default: 'false'
 
      fromCommit:
        description: 'From which commit to start to make the artifacts'
        required: false
        default: ''
 
      toCommit:
        description: 'To which commit to make the artifact'
        required: false
        default: ''
 
      OrgUrl:
        description: 'Domain url of the salesforce org'
        default: 'https://login.salesforce.com'
 
      OrgToken:
        description: 'Access token for the salesforce org'
 
      stepId:
        description: 'stepId'
        required: false
 
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check the variables and set
        id: setvars
        run: |
          echo "Branch: ${{ github.event.inputs.branch }}"
          echo "Diff: ${{ github.event.inputs.diff }}"
          echo "Overall: ${{ github.event.inputs.overall }}"
          echo "From commit: ${{ github.event.inputs.fromCommit }}"
          echo "To commit: ${{ github.event.inputs.toCommit }}"
          echo "Domain URL: ${{ github.event.inputs.OrgUrl }}"
          echo "Access Token: ${{ github.event.inputs.OrgToken }}"
          if [[ "${{ github.event.inputs.diff }}" == "true" && "${{ github.event.inputs.overall }}" == "true" ]]; then
            echo "Both diff and overall cannot be true at the same time"
            exit 1
          fi
 
      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli
 
      - name: Install Salesforce Scanner Plugin
        run: sf plugins install @salesforce/sfdx-scanner
 
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
 
      #  DIFF SCAN 
      - name: Run Diff Scan
        if: ${{ github.event.inputs.diff == 'true' }}
        shell: bash
        run: |
          set +e  # Don't exit on error, we want to handle errors ourselves
          mkdir -p reports
          
          # Initialize error log as empty
          echo "[]" > reports/error_log.json
          
          # Variable to track if SCA execution had errors or was skipped
          SCA_FAILED=false
          SCA_SKIPPED=false
          
          # Get ALL changed files first (for logging)
          ALL_CHANGED_FILES=$(git diff --name-status "${{ github.event.inputs.fromCommit }}" "${{ github.event.inputs.toCommit }}" \
            | awk '/^[AM]/ {print $2}' || true)
          
          echo "All changed files in commits:"
          echo "$ALL_CHANGED_FILES"
          
          # Detect new and modified Apex/Trigger files (A = added, M = modified)
          NEW_FILES=$(git diff --name-status "${{ github.event.inputs.fromCommit }}" "${{ github.event.inputs.toCommit }}" \
            | awk '/^A/ {print $2}' | grep -E '\.(cls|trigger|js)$' || true)
          MODIFIED_FILES=$(git diff --name-status "${{ github.event.inputs.fromCommit }}" "${{ github.event.inputs.toCommit }}" \
            | awk '/^M/ {print $2}' | grep -E '\.(cls|trigger|js)$' || true)
          
          # Check if no Apex/Trigger files found
          if [[ -z "$NEW_FILES" && -z "$MODIFIED_FILES" ]]; then
            echo " No Apex classes or triggers detected in the commit range."
            echo " SCA Skipped - Will upload skip notification to Salesforce..."
            
            # Mark as skipped
            SCA_SKIPPED=true
            
            # Create skip message
            SKIP_MESSAGE="SCA scan was skipped because no Apex classes (.cls) or triggers (.trigger) were found in the commit range. Only other metadata types were changed."
            ESCAPED_SKIP_MSG=$(printf '%s' "$SKIP_MESSAGE" | jq -Rs .)
            echo "[$ESCAPED_SKIP_MSG]" > reports/error_log.json
            
            # Create empty reports
            echo "[]" > reports/diff_full.json
            echo "[]" > reports/diff_delta.json
            
            echo "SCA_SKIPPED=true" >> $GITHUB_ENV
          else
            echo "Apex/Trigger files detected:"
            echo "New files:"
            echo "$NEW_FILES"
            echo "Modified files:"
            echo "$MODIFIED_FILES"
            
            # ---------- FULL SCAN (all violations on changed files) ----------
            if [ -n "$NEW_FILES$MODIFIED_FILES" ]; then
              echo "Running full scan on all changed files..."
              # Capture both stdout and stderr, but keep them separate
              sf scanner:run --format json --target $NEW_FILES $MODIFIED_FILES \
                --outfile reports/diff_full_temp.json > sca_full_stdout.txt 2> sca_full_stderr.txt
              
              SCAN_EXIT_CODE=$?
              
              # Check stderr for parse failures (PMD warnings about files it couldn't parse)
              if grep -q "PMD failed to evaluate against file" sca_full_stderr.txt 2>/dev/null; then
                echo "ERROR: SCA Full Scan - PMD failed to parse one or more files"
                SCA_FAILED=true
                
                # Capture ALL output
                STDOUT_CONTENT=$(cat sca_full_stdout.txt 2>/dev/null || echo "")
                STDERR_CONTENT=$(cat sca_full_stderr.txt 2>/dev/null || echo "")
                
                # Combine all error information
                FULL_ERROR_OUTPUT="${STDERR_CONTENT}${STDOUT_CONTENT}"
                
                # Escape for JSON 
                ESCAPED_ERROR=$(printf '%s' "$FULL_ERROR_OUTPUT" | jq -Rs .)
                
                # Create error log as array with single string
                echo "[$ESCAPED_ERROR]" > reports/error_log.json
                
                # Clear diff_full - NO VIOLATIONS when there's an error
                echo "[]" > reports/diff_full.json
                
                # Remove temp file
                rm -f reports/diff_full_temp.json
              # Check if the JSON output file is valid
              elif [ ! -f reports/diff_full_temp.json ] || ! jq empty reports/diff_full_temp.json 2>/dev/null; then
                echo "ERROR: SCA Full Scan produced invalid JSON - likely due to syntax errors in files"
                SCA_FAILED=true
